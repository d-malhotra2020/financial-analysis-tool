<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analysis Dashboard - Professional</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Ensure smooth scrolling and touch actions */
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        body {
            -webkit-overflow-scrolling: touch;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            color: #1a202c;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            color: #1a365d;
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 1.1rem;
            color: #4a5568;
            font-weight: 400;
        }

        .search-section {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 28px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
            background: #ffffff;
            color: #2d3748;
            font-family: inherit;
        }

        .search-input:focus {
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .search-input::placeholder {
            color: #a0aec0;
        }

        .search-btn, .random-btn {
            padding: 12px 24px;
            background: #3182ce;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .search-btn:hover, .random-btn:hover {
            background: #2c5aa0;
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .suggestions {
            display: none;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #003300;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #4a5568;
        }

        .suggestion-item:hover {
            background: #edf2f7;
            color: #2d3748;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .company-info {
            display: flex;
            flex-direction: column;
        }

        .company-symbol {
            font-weight: bold;
            color: #2d3748;
        }

        .company-name {
            font-size: 0.9rem;
            color: #3182ce;
        }

        .company-sector {
            font-size: 0.8rem;
            color: #2d3748;
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #cbd5e0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .stock-info, .chart-container {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #003300;
        }

        .stock-symbol {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            text-shadow: 0 0 5px #00ff00;
        }

        .stock-name {
            font-size: 1.1rem;
            color: #4a5568;
        }

        .stock-price {
            text-align: right;
        }

        .current-price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            text-shadow: 0 0 5px #00ff00;
        }

        .price-change {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .positive {
            color: #2d3748;
            text-shadow: 0 0 3px #00ff00;
        }

        .negative {
            color: #ff0000;
            text-shadow: 0 0 3px #ff0000;
        }

        .stock-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .detail-label {
            font-weight: 600;
            color: #3182ce;
        }

        .detail-value {
            font-weight: bold;
            color: #2d3748;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-btn, .chart-type-btn {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: #ffffff;
            color: #4a5568;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-family: inherit;
            font-size: 14px;
        }

        .time-btn.active, .time-btn:hover, .chart-type-btn.active, .chart-type-btn:hover {
            background: #3182ce;
            color: #ffffff;
            border-color: #3182ce;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .chart-type-btn {
            padding: 10px 20px;
            font-size: 14px;
            margin: 0 4px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        
        #stockChart {
            width: 100%;
            height: 100%;
        }

        .market-overview {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        .market-overview h2 {
            color: #2d3748;
            text-shadow: 0 0 5px #00ff00;
            margin-bottom: 20px;
        }

        .market-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #ffffff;
            color: #2d3748;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid #004400;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2d3748;
            text-shadow: 0 0 5px #00ff00;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            color: #4a5568;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #3182ce;
        }

        .loading-spinner {
            border: 3px solid #002200;
            border-top: 3px solid #00ff00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #220000;
            color: #ff0000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 2px solid #440000;
            text-shadow: 0 0 3px #ff0000;
        }

        .top-movers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }

        .mover-section {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mover-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2d3748;
            text-shadow: 0 0 5px #00ff00;
        }

        .mover-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #004400;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mover-item:hover {
            background: #f7fafc;
        }

        .mover-item:last-child {
            border-bottom: none;
        }

        .mover-symbol {
            font-weight: bold;
            color: #2d3748;
        }

        .mover-change {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .header {
                padding: 20px 16px;
                margin-bottom: 20px;
            }
            
            .search-section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .search-container {
                flex-direction: column;
                gap: 12px;
            }
            
            .search-btn, .random-btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 16px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .stock-info, .chart-container {
                padding: 20px;
            }
            
            .stock-details {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .detail-item {
                padding: 12px;
            }
            
            .chart-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .chart-controls > div {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .chart-type-btn, .time-btn {
                padding: 12px 16px;
                font-size: 14px;
                flex: 1;
                min-width: 80px;
            }
            
            .market-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-value {
                font-size: 1.4rem;
            }
            
            .top-movers {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .mover-section {
                padding: 16px;
            }
            
            .mover-item {
                padding: 12px;
                font-size: 14px;
            }
            
            .suggestions {
                max-height: 200px;
            }
            
            .suggestion-item {
                padding: 14px;
            }
            
            .chart-wrapper {
                height: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header, .search-section, .stock-info, .chart-container {
                padding: 16px;
            }
            
            .market-stats {
                grid-template-columns: 1fr;
            }
            
            .chart-controls > div {
                gap: 8px;
            }
            
            .time-btn {
                padding: 10px 12px;
                font-size: 13px;
                min-width: 60px;
            }
            
            .chart-type-btn {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .stock-header h2 {
                font-size: 1.3rem;
            }
            
            .stock-price {
                font-size: 1.8rem;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Financial Analysis Dashboard</h1>
            <p>Comprehensive NYSE, NASDAQ, S&P 500 & DOW data with interactive financial charts</p>
        </div>

        <div class="search-section">
            <div class="search-container">
                <div style="position: relative; flex: 1;">
                    <input type="text" class="search-input" id="stockSearch" placeholder="Search NYSE, NASDAQ, S&P 500, DOW stocks (e.g., AAPL, Tesla, Goldman Sachs)" autocomplete="off">
                    <div class="suggestions" id="suggestions"></div>
                </div>
                <button class="search-btn" onclick="searchStock()">Search</button>
                <button class="random-btn" onclick="randomStock()">Random Stock</button>
            </div>
            <div id="searchResults"></div>
        </div>

        <div class="dashboard-grid">
            <div class="stock-info">
                <div id="stockInfoContent">
                    <div style="text-align: center; padding: 40px; color: #006600;">
                        <h3>Search for a stock to view details</h3>
                        <p>Search from 150+ NYSE, NASDAQ, S&P 500 & DOW companies</p>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-controls">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="chart-type-btn active" onclick="changeChartType('candlestick')">Candlestick</button>
                        <button class="chart-type-btn" onclick="changeChartType('ohlc')">OHLC Bars</button>
                        <button class="chart-type-btn" onclick="changeChartType('line')">Line Chart</button>
                        <button class="chart-type-btn" onclick="changeChartType('area')">Area Chart</button>
                        <button class="chart-type-btn" onclick="changeChartType('volume')">Volume Chart</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="time-btn" onclick="changeTimeframe('1d')">1D</button>
                        <button class="time-btn" onclick="changeTimeframe('1w')">1W</button>
                        <button class="time-btn" onclick="changeTimeframe('1mo')">1M</button>
                        <button class="time-btn" onclick="changeTimeframe('3mo')">3M</button>
                        <button class="time-btn active" onclick="changeTimeframe('1y')">1Y</button>
                        <button class="time-btn" onclick="changeTimeframe('5y')">5Y</button>
                        <button class="time-btn" onclick="changeTimeframe('max')">All Time</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>
        </div>

        <div class="market-overview">
            <h2>Market Overview</h2>
            <div class="market-stats">
                <div class="stat-card">
                    <div class="stat-value" id="sp500Value">Loading...</div>
                    <div class="stat-label">S&P 500</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dowValue">Loading...</div>
                    <div class="stat-label">Dow Jones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="nasdaqValue">Loading...</div>
                    <div class="stat-label">NASDAQ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="advancingStocks">Loading...</div>
                    <div class="stat-label">Advancing</div>
                </div>
            </div>
            
            <div class="top-movers">
                <div class="mover-section">
                    <div class="mover-title">Top Gainers</div>
                    <div id="topGainers">Loading...</div>
                </div>
                <div class="mover-section">
                    <div class="mover-title">Top Losers</div>
                    <div id="topLosers">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChart = null;
        let currentSymbol = null;
        let currentTimeframe = '1y';
        let currentChartType = 'candlestick';
        let allStocks = [];
        let cachedChartData = null;
        let cachedDataKey = null; // Cache for consistent chart data

        // Comprehensive US Stock Database (NYSE, NASDAQ, S&P 500, DOW)
        const stockDatabase = [
            // FAANG + Major Tech
            {symbol: "AAPL", name: "Apple Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "MSFT", name: "Microsoft Corporation", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "GOOGL", name: "Alphabet Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "GOOG", name: "Alphabet Inc. Class C", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "AMZN", name: "Amazon.com Inc.", sector: "Consumer Discretionary", exchange: "NASDAQ"},
            {symbol: "META", name: "Meta Platforms Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "NFLX", name: "Netflix Inc.", sector: "Communication Services", exchange: "NASDAQ"},
            {symbol: "NVDA", name: "NVIDIA Corporation", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "AMD", name: "Advanced Micro Devices", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "INTC", name: "Intel Corporation", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "ORCL", name: "Oracle Corporation", sector: "Technology", exchange: "NYSE"},
            {symbol: "CRM", name: "Salesforce Inc.", sector: "Technology", exchange: "NYSE"},
            {symbol: "ADBE", name: "Adobe Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "PYPL", name: "PayPal Holdings Inc.", sector: "Financials", exchange: "NASDAQ"},
            {symbol: "SPOT", name: "Spotify Technology SA", sector: "Communication Services", exchange: "NYSE"},
            
            // DOW 30 Companies
            {symbol: "MMM", name: "3M Company", sector: "Industrials", exchange: "NYSE"},
            {symbol: "AXP", name: "American Express Co.", sector: "Financials", exchange: "NYSE"},
            {symbol: "AMGN", name: "Amgen Inc.", sector: "Healthcare", exchange: "NASDAQ"},
            {symbol: "BA", name: "Boeing Co.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "CAT", name: "Caterpillar Inc.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "CVX", name: "Chevron Corporation", sector: "Energy", exchange: "NYSE"},
            {symbol: "CSCO", name: "Cisco Systems Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "KO", name: "Coca-Cola Co.", sector: "Consumer Staples", exchange: "NYSE"},
            {symbol: "DOW", name: "Dow Inc.", sector: "Materials", exchange: "NYSE"},
            {symbol: "GS", name: "Goldman Sachs Group Inc.", sector: "Financials", exchange: "NYSE"},
            {symbol: "HD", name: "Home Depot Inc.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "HON", name: "Honeywell International Inc.", sector: "Industrials", exchange: "NASDAQ"},
            {symbol: "IBM", name: "International Business Machines", sector: "Technology", exchange: "NYSE"},
            {symbol: "JNJ", name: "Johnson & Johnson", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "JPM", name: "JPMorgan Chase & Co.", sector: "Financials", exchange: "NYSE"},
            {symbol: "MCD", name: "McDonald's Corp.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "MRK", name: "Merck & Co Inc.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "NKE", name: "Nike Inc.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "PG", name: "Procter & Gamble Co.", sector: "Consumer Staples", exchange: "NYSE"},
            {symbol: "TRV", name: "Travelers Companies Inc.", sector: "Financials", exchange: "NYSE"},
            {symbol: "UNH", name: "UnitedHealth Group Inc.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "VZ", name: "Verizon Communications Inc.", sector: "Communication Services", exchange: "NYSE"},
            {symbol: "V", name: "Visa Inc.", sector: "Financials", exchange: "NYSE"},
            {symbol: "WBA", name: "Walgreens Boots Alliance Inc.", sector: "Consumer Staples", exchange: "NASDAQ"},
            {symbol: "WMT", name: "Walmart Inc.", sector: "Consumer Staples", exchange: "NYSE"},
            {symbol: "DIS", name: "Walt Disney Co.", sector: "Communication Services", exchange: "NYSE"},
            
            // Major S&P 500 Companies
            {symbol: "TSLA", name: "Tesla Inc.", sector: "Consumer Discretionary", exchange: "NASDAQ"},
            {symbol: "BRK.A", name: "Berkshire Hathaway Inc. Class A", sector: "Financials", exchange: "NYSE"},
            {symbol: "BRK.B", name: "Berkshire Hathaway Inc. Class B", sector: "Financials", exchange: "NYSE"},
            {symbol: "AVGO", name: "Broadcom Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "MA", name: "Mastercard Inc.", sector: "Financials", exchange: "NYSE"},
            {symbol: "PFE", name: "Pfizer Inc.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "ABBV", name: "AbbVie Inc.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "BAC", name: "Bank of America Corp.", sector: "Financials", exchange: "NYSE"},
            {symbol: "PEP", name: "PepsiCo Inc.", sector: "Consumer Staples", exchange: "NASDAQ"},
            {symbol: "COST", name: "Costco Wholesale Corp.", sector: "Consumer Staples", exchange: "NASDAQ"},
            {symbol: "TMO", name: "Thermo Fisher Scientific Inc.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "ACN", name: "Accenture PLC", sector: "Technology", exchange: "NYSE"},
            {symbol: "ABT", name: "Abbott Laboratories", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "CMCSA", name: "Comcast Corp.", sector: "Communication Services", exchange: "NASDAQ"},
            {symbol: "DHR", name: "Danaher Corp.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "TXN", name: "Texas Instruments Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "NEE", name: "NextEra Energy Inc.", sector: "Utilities", exchange: "NYSE"},
            {symbol: "BMY", name: "Bristol Myers Squibb Co.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "PM", name: "Philip Morris International Inc.", sector: "Consumer Staples", exchange: "NYSE"},
            {symbol: "RTX", name: "Raytheon Technologies Corp.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "QCOM", name: "Qualcomm Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "UPS", name: "United Parcel Service Inc.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "T", name: "AT&T Inc.", sector: "Communication Services", exchange: "NYSE"},
            {symbol: "SBUX", name: "Starbucks Corp.", sector: "Consumer Discretionary", exchange: "NASDAQ"},
            {symbol: "MDT", name: "Medtronic PLC", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "LOW", name: "Lowe's Companies Inc.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "AMT", name: "American Tower Corp.", sector: "Real Estate", exchange: "NYSE"},
            
            // Financial Sector Giants
            {symbol: "C", name: "Citigroup Inc.", sector: "Financials", exchange: "NYSE"},
            {symbol: "WFC", name: "Wells Fargo & Co.", sector: "Financials", exchange: "NYSE"},
            {symbol: "MS", name: "Morgan Stanley", sector: "Financials", exchange: "NYSE"},
            {symbol: "BLK", name: "BlackRock Inc.", sector: "Financials", exchange: "NYSE"},
            {symbol: "SCHW", name: "Charles Schwab Corp.", sector: "Financials", exchange: "NYSE"},
            {symbol: "AIG", name: "American International Group", sector: "Financials", exchange: "NYSE"},
            
            // Energy Sector
            {symbol: "XOM", name: "Exxon Mobil Corp.", sector: "Energy", exchange: "NYSE"},
            {symbol: "COP", name: "ConocoPhillips", sector: "Energy", exchange: "NYSE"},
            {symbol: "SLB", name: "Schlumberger NV", sector: "Energy", exchange: "NYSE"},
            {symbol: "OXY", name: "Occidental Petroleum Corp.", sector: "Energy", exchange: "NYSE"},
            {symbol: "EOG", name: "EOG Resources Inc.", sector: "Energy", exchange: "NYSE"},
            
            // Healthcare & Biotech
            {symbol: "LLY", name: "Eli Lilly and Co.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "GILD", name: "Gilead Sciences Inc.", sector: "Healthcare", exchange: "NASDAQ"},
            {symbol: "BIIB", name: "Biogen Inc.", sector: "Healthcare", exchange: "NASDAQ"},
            {symbol: "REGN", name: "Regeneron Pharmaceuticals", sector: "Healthcare", exchange: "NASDAQ"},
            {symbol: "VRTX", name: "Vertex Pharmaceuticals Inc.", sector: "Healthcare", exchange: "NASDAQ"},
            {symbol: "CI", name: "Cigna Corp.", sector: "Healthcare", exchange: "NYSE"},
            {symbol: "CVS", name: "CVS Health Corp.", sector: "Healthcare", exchange: "NYSE"},
            
            // Consumer & Retail
            {symbol: "TGT", name: "Target Corp.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "F", name: "Ford Motor Co.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "GM", name: "General Motors Co.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "CCL", name: "Carnival Corp.", sector: "Consumer Discretionary", exchange: "NYSE"},
            {symbol: "NCLH", name: "Norwegian Cruise Line Holdings", sector: "Consumer Discretionary", exchange: "NYSE"},
            
            // Industrial & Manufacturing
            {symbol: "GE", name: "General Electric Co.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "LMT", name: "Lockheed Martin Corp.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "NOC", name: "Northrop Grumman Corp.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "FDX", name: "FedEx Corp.", sector: "Industrials", exchange: "NYSE"},
            {symbol: "DE", name: "Deere & Co.", sector: "Industrials", exchange: "NYSE"},
            
            // Technology & Software
            {symbol: "NOW", name: "ServiceNow Inc.", sector: "Technology", exchange: "NYSE"},
            {symbol: "SNOW", name: "Snowflake Inc.", sector: "Technology", exchange: "NYSE"},
            {symbol: "PLTR", name: "Palantir Technologies Inc.", sector: "Technology", exchange: "NYSE"},
            {symbol: "UBER", name: "Uber Technologies Inc.", sector: "Technology", exchange: "NYSE"},
            {symbol: "LYFT", name: "Lyft Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "ZOOM", name: "Zoom Video Communications", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "DOCU", name: "DocuSign Inc.", sector: "Technology", exchange: "NASDAQ"},
            {symbol: "SHOP", name: "Shopify Inc.", sector: "Technology", exchange: "NYSE"},
            
            // Communication & Media
            {symbol: "TMUS", name: "T-Mobile US Inc.", sector: "Communication Services", exchange: "NASDAQ"},
            {symbol: "CHTR", name: "Charter Communications Inc.", sector: "Communication Services", exchange: "NASDAQ"},
            {symbol: "DISH", name: "DISH Network Corp.", sector: "Communication Services", exchange: "NASDAQ"},
            
            // Utilities
            {symbol: "SO", name: "Southern Co.", sector: "Utilities", exchange: "NYSE"},
            {symbol: "DUK", name: "Duke Energy Corp.", sector: "Utilities", exchange: "NYSE"},
            {symbol: "D", name: "Dominion Energy Inc.", sector: "Utilities", exchange: "NYSE"},
            
            // Real Estate & REITs
            {symbol: "CCI", name: "Crown Castle International", sector: "Real Estate", exchange: "NYSE"},
            {symbol: "PLD", name: "Prologis Inc.", sector: "Real Estate", exchange: "NYSE"},
            {symbol: "EQIX", name: "Equinix Inc.", sector: "Real Estate", exchange: "NASDAQ"},
            
            // Materials & Commodities
            {symbol: "LIN", name: "Linde PLC", sector: "Materials", exchange: "NYSE"},
            {symbol: "APD", name: "Air Products and Chemicals", sector: "Materials", exchange: "NYSE"},
            {symbol: "FCX", name: "Freeport-McMoRan Inc.", sector: "Materials", exchange: "NYSE"},
            
            // Popular Growth Stocks
            {symbol: "ROKU", name: "Roku Inc.", sector: "Communication Services", exchange: "NASDAQ"},
            {symbol: "SQ", name: "Block Inc.", sector: "Technology", exchange: "NYSE"},
            {symbol: "TWTR", name: "Twitter Inc.", sector: "Communication Services", exchange: "NYSE"},
            {symbol: "SNAP", name: "Snap Inc.", sector: "Communication Services", exchange: "NYSE"},
            {symbol: "PINS", name: "Pinterest Inc.", sector: "Communication Services", exchange: "NYSE"},
            
            // ETFs & Popular Funds
            {symbol: "SPY", name: "SPDR S&P 500 ETF Trust", sector: "Fund", exchange: "NYSE"},
            {symbol: "QQQ", name: "Invesco QQQ Trust", sector: "Fund", exchange: "NASDAQ"},
            {symbol: "IWM", name: "iShares Russell 2000 ETF", sector: "Fund", exchange: "NYSE"},
            {symbol: "VTI", name: "Vanguard Total Stock Market ETF", sector: "Fund", exchange: "NYSE"},
            {symbol: "VOO", name: "Vanguard S&P 500 ETF", sector: "Fund", exchange: "NYSE"}
        ];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketOverview();
            setupSearch();
            
            // Load a random stock by default
            const randomStock = stockDatabase[Math.floor(Math.random() * stockDatabase.length)];
            document.getElementById('stockSearch').value = randomStock.symbol;
            loadStockData(randomStock.symbol);
            
            // Update market data every 5 minutes
            setInterval(loadMarketOverview, 300000);
        });

        function setupSearch() {
            const searchInput = document.getElementById('stockSearch');
            const suggestions = document.getElementById('suggestions');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    suggestions.style.display = 'none';
                    return;
                }

                const filtered = stockDatabase.filter(stock => 
                    stock.symbol.toLowerCase().includes(query) ||
                    stock.name.toLowerCase().includes(query) ||
                    stock.sector.toLowerCase().includes(query) ||
                    stock.exchange.toLowerCase().includes(query)
                ).slice(0, 10);

                if (filtered.length > 0) {
                    suggestions.innerHTML = filtered.map(stock => `
                        <div class="suggestion-item" onclick="selectStock('${stock.symbol}')">
                            <div class="company-info">
                                <div class="company-symbol">${stock.symbol} <span style="font-size: 0.8rem; color: #004400;">(${stock.exchange})</span></div>
                                <div class="company-name">${stock.name}</div>
                            </div>
                            <div class="company-sector">${stock.sector}</div>
                        </div>
                    `).join('');
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    suggestions.style.display = 'none';
                }
            });

            // Handle Enter key
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchStock();
                }
            });
        }

        function selectStock(symbol) {
            document.getElementById('stockSearch').value = symbol;
            document.getElementById('suggestions').style.display = 'none';
            loadStockData(symbol);
        }

        function searchStock() {
            const query = document.getElementById('stockSearch').value.trim().toUpperCase();
            if (query) {
                loadStockData(query);
                document.getElementById('suggestions').style.display = 'none';
            }
        }

        function randomStock() {
            const randomStock = stockDatabase[Math.floor(Math.random() * stockDatabase.length)];
            document.getElementById('stockSearch').value = randomStock.symbol;
            loadStockData(randomStock.symbol);
        }

        async function loadStockData(symbol) {
            currentSymbol = symbol;
            
            // Show loading state
            document.getElementById('stockInfoContent').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading ${symbol} data...</div>
                </div>
            `;

            try {
                // Fetch stock data
                const response = await fetch(`/api/v1/stocks/${symbol}?include_history=true&history_days=252`);
                
                if (!response.ok) {
                    throw new Error(`Stock ${symbol} not found`);
                }

                const data = await response.json();
                displayStockInfo(data);
                await loadStockChart(symbol, currentTimeframe);

            } catch (error) {
                document.getElementById('stockInfoContent').innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                    <div style="text-align: center; padding: 20px; color: #006600;">
                        <p>Please try searching for another stock symbol.</p>
                    </div>
                `;
            }
        }

        function displayStockInfo(data) {
            const price = data.latest_price;
            const analysis = data.latest_analysis;
            
            // Calculate real growth rate from price data
            const currentPrice = price.close_price;
            const openPrice = price.open_price;
            const dailyChange = currentPrice - openPrice;
            const dailyChangePercent = ((dailyChange / openPrice) * 100);
            
            const changePercent = dailyChangePercent >= 0 ? 
                `+${Math.abs(dailyChangePercent).toFixed(2)}` : 
                `-${Math.abs(dailyChangePercent).toFixed(2)}`;
            const changeClass = dailyChangePercent >= 0 ? 'positive' : 'negative';

            document.getElementById('stockInfoContent').innerHTML = `
                <div class="stock-header">
                    <div>
                        <div class="stock-symbol">${data.symbol}</div>
                        <div class="stock-name">${data.name}</div>
                    </div>
                    <div class="stock-price">
                        <div class="current-price">$${price.close_price}</div>
                        <div class="price-change ${changeClass}">
                            ${dailyChange >= 0 ? '+' : ''}${dailyChange.toFixed(2)} (${changePercent}%) ${dailyChange >= 0 ? '↗' : '↘'}
                        </div>
                    </div>
                </div>
                
                <div class="stock-details">
                    <div class="detail-item">
                        <span class="detail-label">Open:</span>
                        <span class="detail-value">$${price.open_price}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">High:</span>
                        <span class="detail-value">$${price.high_price}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Low:</span>
                        <span class="detail-value">$${price.low_price}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Volume:</span>
                        <span class="detail-value">${price.volume.toLocaleString()}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Market Cap:</span>
                        <span class="detail-value">$${(data.market_cap / 1000000000).toFixed(1)}B</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Sector:</span>
                        <span class="detail-value">${data.sector}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">RSI:</span>
                        <span class="detail-value">${analysis.rsi}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Recommendation: </span>
                        <span class="detail-value ${analysis.recommendation === 'BUY' ? 'positive' : analysis.recommendation === 'SELL' ? 'negative' : ''}">${analysis.recommendation}</span>
                    </div>
                </div>
            `;
        }

        async function loadStockChart(symbol, timeframe) {
            try {
                // Check if we have cached data for this symbol and timeframe
                const dataKey = `${symbol}-${timeframe}`;
                let data;
                
                if (cachedChartData && cachedDataKey === dataKey) {
                    data = cachedChartData;
                } else {
                    const response = await fetch(`/api/v1/stocks/${symbol}/chart?period=${timeframe}`);
                    data = await response.json();
                    // Cache the data
                    cachedChartData = data;
                    cachedDataKey = dataKey;
                }

                // Clean up previous charts
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }

                // Create chart on canvas
                const chartCanvas = document.getElementById('stockChart');
                const ctx = chartCanvas.getContext('2d');
                createChart(ctx, data, symbol, currentChartType);

            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        function createCustomCandlestickChart(ctx, data, symbol) {
            // Setup high-DPI canvas
            const canvas = ctx.canvas;
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // Set actual canvas size in memory
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // Scale canvas back down using CSS
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            // Scale the drawing context so everything will work at the higher DPI
            ctx.scale(dpr, dpr);
            
            // Clear canvas
            ctx.clearRect(0, 0, rect.width, rect.height);
            
            // Professional candlestick chart implementation
            const width = rect.width;
            const height = rect.height;
            
            // Chart margins and dimensions
            const margin = { top: 50, right: 80, bottom: 60, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Process OHLC data
            const ohlcData = data.data.map(item => ({
                date: new Date(item.timestamp),
                open: parseFloat(item.open),
                high: parseFloat(item.high),
                low: parseFloat(item.low),
                close: parseFloat(item.close),
                volume: parseInt(item.volume)
            }));
            
            // Calculate price range
            const allPrices = [];
            ohlcData.forEach(d => {
                allPrices.push(d.high, d.low);
            });
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);
            const priceRange = maxPrice - minPrice;
            const padding = priceRange * 0.05; // 5% padding
            
            const yMin = minPrice - padding;
            const yMax = maxPrice + padding;
            
            // Limit data points for better visualization
            const maxDataPoints = currentTimeframe === '1d' ? 13 : 
                                 currentTimeframe === '1w' ? 7 : 
                                 currentTimeframe === '1mo' ? 30 : 
                                 currentTimeframe === '3mo' ? 90 : 
                                 currentTimeframe === '1y' ? 252 :
                                 currentTimeframe === '5y' ? 1260 :
                                 currentTimeframe === 'max' ? 2520 : 252;
            
            const displayData = ohlcData.length > maxDataPoints 
                ? ohlcData.slice(-maxDataPoints) 
                : ohlcData;
            
            // Set up coordinate system
            const xScale = chartWidth / displayData.length;
            const yScale = chartHeight / (yMax - yMin);
            
            // Helper function to get Y coordinate
            function getY(price) {
                return margin.top + chartHeight - ((price - yMin) * yScale);
            }
            
            // Helper function to get X coordinate
            function getX(index) {
                return margin.left + (index * xScale) + (xScale / 2);
            }
            
            // Draw grid lines
            ctx.strokeStyle = 'rgba(226, 232, 240, 0.3)';
            ctx.lineWidth = 0.5;
            
            // Horizontal grid lines (price levels)
            const gridLines = 8;
            for (let i = 0; i <= gridLines; i++) {
                const price = yMin + (yMax - yMin) * (i / gridLines);
                const y = getY(price);
                
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + chartWidth, y);
                ctx.stroke();
                
                // Price labels
                ctx.fillStyle = '#4a5568';
                ctx.font = '11px "Consolas", "Monaco", "Courier New", monospace';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText('$' + price.toFixed(2), width - margin.right + 70, y);
            }
            
            // Vertical grid lines (time)
            const timeGrids = Math.min(6, displayData.length - 1);
            for (let i = 0; i <= timeGrids; i++) {
                const index = Math.floor(displayData.length * (i / timeGrids));
                if (index < displayData.length) {
                    const x = getX(index);
                    
                    ctx.beginPath();
                    ctx.moveTo(x, margin.top);
                    ctx.lineTo(x, margin.top + chartHeight);
                    ctx.stroke();
                    
                    // Time labels
                    ctx.fillStyle = '#718096';
                    ctx.font = '11px "Consolas", "Monaco", "Courier New", monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    const dateStr = currentTimeframe === '1d' 
                        ? displayData[index].date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                        : currentTimeframe === '1w' || currentTimeframe === '1mo'
                        ? displayData[index].date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        : displayData[index].date.toLocaleDateString('en-US', { year: '2-digit', month: 'short' });
                    ctx.fillText(dateStr, x, height - margin.bottom + 10);
                }
            }
            
            // Draw candlesticks
            displayData.forEach((d, i) => {
                const x = getX(i);
                const candleWidth = Math.max(2, xScale * 0.7);
                
                const openY = getY(d.open);
                const closeY = getY(d.close);
                const highY = getY(d.high);
                const lowY = getY(d.low);
                
                const isBullish = d.close >= d.open;
                
                // Colors: Professional teal for bullish, red for bearish
                const bullishColor = '#26a69a';
                const bearishColor = '#ef5350';
                const color = isBullish ? bullishColor : bearishColor;
                
                // Draw high-low line (wick)
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // Draw body
                const bodyTop = Math.min(openY, closeY);
                const bodyHeight = Math.abs(closeY - openY);
                
                if (isBullish) {
                    // Bullish candle: hollow (white/transparent with colored border)
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(x - candleWidth/2, bodyTop, candleWidth, bodyHeight);
                    ctx.strokeStyle = bullishColor;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x - candleWidth/2, bodyTop, candleWidth, bodyHeight);
                } else {
                    // Bearish candle: filled
                    ctx.fillStyle = bearishColor;
                    ctx.fillRect(x - candleWidth/2, bodyTop, candleWidth, bodyHeight);
                }
            });
            
            // Draw chart title
            ctx.fillStyle = '#2d3748';
            ctx.font = 'bold 16px "Inter", -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(`${symbol} - Japanese Candlestick Chart`, width / 2, 15);
            
            // Draw axis labels
            ctx.fillStyle = '#4a5568';
            ctx.font = '12px "Inter", -apple-system, BlinkMacSystemFont, sans-serif';
            
            // Y-axis label
            ctx.save();
            ctx.translate(20, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('Price ($)', 0, 0);
            ctx.restore();
            
            // X-axis label
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText('Time', width / 2, height - 10);
        }
        
        function createCustomOHLCChart(ctx, data, symbol) {
            // Setup high-DPI canvas
            const canvas = ctx.canvas;
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // Set actual canvas size in memory
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // Scale canvas back down using CSS
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            // Scale the drawing context so everything will work at the higher DPI
            ctx.scale(dpr, dpr);
            
            // Clear canvas
            ctx.clearRect(0, 0, rect.width, rect.height);
            
            // Professional OHLC chart implementation
            const width = rect.width;
            const height = rect.height;
            
            // Chart margins and dimensions
            const margin = { top: 50, right: 80, bottom: 60, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Process OHLC data
            const ohlcData = data.data.map(item => ({
                date: new Date(item.timestamp),
                open: parseFloat(item.open),
                high: parseFloat(item.high),
                low: parseFloat(item.low),
                close: parseFloat(item.close),
                volume: parseInt(item.volume)
            }));
            
            // Calculate price range
            const allPrices = [];
            ohlcData.forEach(d => {
                allPrices.push(d.high, d.low);
            });
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);
            const priceRange = maxPrice - minPrice;
            const padding = priceRange * 0.05; // 5% padding
            
            const yMin = minPrice - padding;
            const yMax = maxPrice + padding;
            
            // Limit data points for better visualization
            const maxDataPoints = currentTimeframe === '1d' ? 13 : 
                                 currentTimeframe === '1w' ? 7 : 
                                 currentTimeframe === '1mo' ? 30 : 
                                 currentTimeframe === '3mo' ? 90 : 
                                 currentTimeframe === '1y' ? 252 :
                                 currentTimeframe === '5y' ? 1260 :
                                 currentTimeframe === 'max' ? 2520 : 252;
            
            const displayData = ohlcData.length > maxDataPoints 
                ? ohlcData.slice(-maxDataPoints) 
                : ohlcData;
            
            // Set up coordinate system
            const xScale = chartWidth / displayData.length;
            const yScale = chartHeight / (yMax - yMin);
            
            // Helper function to get Y coordinate
            function getY(price) {
                return margin.top + chartHeight - ((price - yMin) * yScale);
            }
            
            // Helper function to get X coordinate
            function getX(index) {
                return margin.left + (index * xScale) + (xScale / 2);
            }
            
            // Draw grid lines (same as candlestick)
            ctx.strokeStyle = 'rgba(226, 232, 240, 0.3)';
            ctx.lineWidth = 0.5;
            
            // Horizontal grid lines
            const gridLines = 8;
            for (let i = 0; i <= gridLines; i++) {
                const price = yMin + (yMax - yMin) * (i / gridLines);
                const y = getY(price);
                
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + chartWidth, y);
                ctx.stroke();
                
                // Price labels
                ctx.fillStyle = '#4a5568';
                ctx.font = '11px "Consolas", "Monaco", "Courier New", monospace';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText('$' + price.toFixed(2), width - margin.right + 70, y);
            }
            
            // Vertical grid lines
            const timeGrids = Math.min(6, displayData.length - 1);
            for (let i = 0; i <= timeGrids; i++) {
                const index = Math.floor(displayData.length * (i / timeGrids));
                if (index < displayData.length) {
                    const x = getX(index);
                    
                    ctx.beginPath();
                    ctx.moveTo(x, margin.top);
                    ctx.lineTo(x, margin.top + chartHeight);
                    ctx.stroke();
                    
                    // Time labels
                    ctx.fillStyle = '#718096';
                    ctx.font = '11px "Consolas", "Monaco", "Courier New", monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    const dateStr = currentTimeframe === '1d' 
                        ? displayData[index].date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                        : currentTimeframe === '1w' || currentTimeframe === '1mo'
                        ? displayData[index].date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        : displayData[index].date.toLocaleDateString('en-US', { year: '2-digit', month: 'short' });
                    ctx.fillText(dateStr, x, height - margin.bottom + 10);
                }
            }
            
            // Draw OHLC bars
            displayData.forEach((d, i) => {
                const x = getX(i);
                const tickWidth = Math.max(3, xScale * 0.4);
                
                const openY = getY(d.open);
                const closeY = getY(d.close);
                const highY = getY(d.high);
                const lowY = getY(d.low);
                
                const isBullish = d.close >= d.open;
                
                // Colors: Professional teal for bullish, red for bearish
                const color = isBullish ? '#26a69a' : '#ef5350';
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                
                // Draw high-low vertical line
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // Draw open tick (left)
                ctx.beginPath();
                ctx.moveTo(x - tickWidth, openY);
                ctx.lineTo(x, openY);
                ctx.stroke();
                
                // Draw close tick (right)
                ctx.beginPath();
                ctx.moveTo(x, closeY);
                ctx.lineTo(x + tickWidth, closeY);
                ctx.stroke();
            });
            
            // Draw chart title
            ctx.fillStyle = '#2d3748';
            ctx.font = 'bold 16px "Inter", -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(`${symbol} - OHLC Bar Chart`, width / 2, 15);
            
            // Draw axis labels
            ctx.fillStyle = '#4a5568';
            ctx.font = '12px "Inter", -apple-system, BlinkMacSystemFont, sans-serif';
            
            // Y-axis label
            ctx.save();
            ctx.translate(20, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('Price ($)', 0, 0);
            ctx.restore();
            
            // X-axis label
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText('Time', width / 2, height - 10);
        }

        function createChart(ctx, data, symbol, chartType) {
            const priceData = data.data.map(item => ({
                x: new Date(item.timestamp),
                y: item.close
            }));

            const volumeData = data.data.map(item => ({
                x: new Date(item.timestamp),
                y: item.volume
            }));

            let datasets = [];
            let chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: `${symbol} - ${getChartTitle(chartType)}`
                    },
                    legend: {
                        display: chartType !== 'volume'
                    }
                },
                scales: {}
            };

            // Configure datasets and options based on chart type
            switch (chartType) {
                case 'candlestick':
                    // Custom Professional Candlestick Chart
                    createCustomCandlestickChart(ctx, data, symbol);
                    return;

                case 'ohlc':
                    // Custom Professional OHLC Chart
                    createCustomOHLCChart(ctx, data, symbol);
                    return;

                case 'line':
                    datasets = [{
                        label: `${symbol} Price`,
                        data: priceData,
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        borderWidth: 3
                    }];
                    break;

                case 'area':
                    datasets = [{
                        label: `${symbol} Price`,
                        data: priceData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        borderWidth: 2
                    }];
                    break;

                case 'bar':
                    datasets = [{
                        label: `${symbol} Daily Change`,
                        data: data.data.map(item => ({
                            x: new Date(item.timestamp),
                            y: item.close - item.open
                        })),
                        backgroundColor: data.data.map(item => 
                            item.close >= item.open ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'
                        ),
                        borderColor: data.data.map(item => 
                            item.close >= item.open ? '#10b981' : '#ef4444'
                        ),
                        borderWidth: 1
                    }];
                    break;

                case 'volume':
                    datasets = [{
                        label: `${symbol} Volume`,
                        data: volumeData,
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: '#6366f1',
                        borderWidth: 1
                    }];
                    break;
            }

            // Add appropriate scales
            if (chartType === 'candlestick' || chartType === 'ohlc') {
                // Professional financial chart scales with enhanced styling
                chartOptions.scales = {
                    x: {
                        type: 'time',
                        time: {
                            unit: currentTimeframe === '1d' ? 'hour' : 
                                  currentTimeframe === '1w' || currentTimeframe === '1mo' ? 'day' :
                                  'month',
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'MMM dd',
                                week: 'MMM dd',
                                month: 'MMM yyyy'
                            }
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.3)',
                            borderColor: '#e2e8f0',
                            lineWidth: 0.5
                        },
                        ticks: {
                            color: '#718096',
                            font: {
                                family: "'Consolas', 'Monaco', 'Courier New', monospace",
                                size: 11
                            }
                        }
                    },
                    y: {
                        beginAtZero: false,
                        position: 'right', // Professional style - price scale on right
                        grid: {
                            color: 'rgba(226, 232, 240, 0.3)',
                            borderColor: '#e2e8f0',
                            lineWidth: 0.5
                        },
                        ticks: {
                            color: '#4a5568',
                            font: {
                                family: "'Consolas', 'Monaco', 'Courier New', monospace",
                                size: 10,
                                weight: '500'
                            },
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            },
                            padding: 8
                        },
                        title: {
                            display: true,
                            text: 'Price ($)',
                            color: '#4a5568',
                            font: {
                                family: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
                                size: 12,
                                weight: '600'
                            }
                        }
                    }
                };
                
                // Enhanced tooltips for professional candlestick/OHLC
                chartOptions.plugins.tooltip = {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#e2e8f0',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    displayColors: false,
                    titleFont: {
                        family: "'Consolas', 'Monaco', 'Courier New', monospace",
                        size: 12,
                        weight: 'bold'
                    },
                    bodyFont: {
                        family: "'Consolas', 'Monaco', 'Courier New', monospace",
                        size: 11
                    },
                    callbacks: {
                        title: function(tooltipItems) {
                            const date = new Date(tooltipItems[0].parsed.x);
                            return date.toLocaleDateString() + ' ' + (currentTimeframe === '1d' ? date.toLocaleTimeString() : '');
                        },
                        label: function(context) {
                            const dataPoint = context.raw;
                            return [
                                `Open: $${dataPoint.o.toFixed(2)}`,
                                `High: $${dataPoint.h.toFixed(2)}`,
                                `Low: $${dataPoint.l.toFixed(2)}`,
                                `Close: $${dataPoint.c.toFixed(2)}`,
                                `Change: ${dataPoint.c >= dataPoint.o ? '+' : ''}${(dataPoint.c - dataPoint.o).toFixed(2)} (${(((dataPoint.c - dataPoint.o) / dataPoint.o) * 100).toFixed(2)}%)`
                            ];
                        }
                    }
                };
            } else if (chartType === 'volume') {
                chartOptions.scales = {
                    x: {
                        type: 'time',
                        time: {
                            unit: currentTimeframe === '1d' ? 'hour' : 
                                  currentTimeframe === '1w' || currentTimeframe === '1mo' ? 'day' :
                                  'month'
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)',
                            borderColor: '#e2e8f0'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)',
                            borderColor: '#e2e8f0'
                        },
                        ticks: {
                            color: '#718096',
                            callback: function(value) {
                                return (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                };
            } else {
                chartOptions.scales = {
                    x: {
                        type: 'time',
                        time: {
                            unit: currentTimeframe === '1d' ? 'hour' : 
                                  currentTimeframe === '1w' || currentTimeframe === '1mo' ? 'day' :
                                  'month'
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)',
                            borderColor: '#e2e8f0'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)',
                            borderColor: '#e2e8f0'
                        },
                        ticks: {
                            color: '#718096',
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                };
            }

            // Determine Chart.js chart type
            let chartjsType;
            if (chartType === 'candlestick') {
                chartjsType = 'candlestick';
            } else if (chartType === 'ohlc') {
                chartjsType = 'ohlc';
            } else if (chartType === 'area') {
                chartjsType = 'line';
            } else if (chartType === 'volume') {
                chartjsType = 'bar';
            } else {
                chartjsType = chartType;
            }

            currentChart = new Chart(ctx, {
                type: chartjsType,
                data: { datasets },
                options: chartOptions
            });
        }

        function getChartTitle(chartType) {
            const titles = {
                'candlestick': 'Japanese Candlestick Chart',
                'ohlc': 'OHLC Bar Chart',
                'line': 'Price Movement',
                'area': 'Price Trend',
                'bar': 'Daily Price Changes', 
                'volume': 'Trading Volume'
            };
            return titles[chartType] || 'Price Chart';
        }

        function changeTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update button states
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (currentSymbol) {
                loadStockChart(currentSymbol, timeframe);
            }
        }

        function changeChartType(chartType) {
            currentChartType = chartType;
            
            // Update button states
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (currentSymbol) {
                loadStockChart(currentSymbol, currentTimeframe);
            }
        }

        async function loadMarketOverview() {
            try {
                // Load S&P 500 overview
                const sp500Response = await fetch('/api/v1/sp500/');
                const sp500Data = await sp500Response.json();
                
                // Update market indices
                const indices = sp500Data.market_indices;
                document.getElementById('sp500Value').textContent = indices['S&P 500'].value.toFixed(2);
                document.getElementById('dowValue').textContent = indices['Dow Jones'].value.toFixed(0);
                document.getElementById('nasdaqValue').textContent = indices['NASDAQ'].value.toFixed(2);
                document.getElementById('advancingStocks').textContent = sp500Data.market_summary.advancing_stocks;

                // Load top gainers and losers
                const [gainersResponse, losersResponse] = await Promise.all([
                    fetch('/api/v1/sp500/gainers'),
                    fetch('/api/v1/sp500/losers')
                ]);

                const gainersData = await gainersResponse.json();
                const losersData = await losersResponse.json();

                // Display top gainers
                document.getElementById('topGainers').innerHTML = gainersData.gainers.slice(0, 5).map(stock => `
                    <div class="mover-item" onclick="selectStock('${stock.symbol}')" style="cursor: pointer;">
                        <div>
                            <div class="mover-symbol">${stock.symbol}</div>
                            <div style="font-size: 0.9rem; color: #006600;">${stock.name}</div>
                        </div>
                        <div class="mover-change positive">+${stock.change_percent}%</div>
                    </div>
                `).join('');

                // Display top losers
                document.getElementById('topLosers').innerHTML = losersData.losers.slice(0, 5).map(stock => `
                    <div class="mover-item" onclick="selectStock('${stock.symbol}')" style="cursor: pointer;">
                        <div>
                            <div class="mover-symbol">${stock.symbol}</div>
                            <div style="font-size: 0.9rem; color: #006600;">${stock.name}</div>
                        </div>
                        <div class="mover-change negative">${stock.change_percent}%</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading market overview:', error);
            }
        }
    </script>
</body>
</html>